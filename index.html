<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不锈钢牌号查询工作站（台州国富 唐淼 2025 Beta 1.3）</title>
    
    <!-- SEO优化 -->
    <meta name="description" content="专业的不锈钢牌号查询工作站，支持GB、ASTM、EN三大标准，提供智能搜索、对比分析、数据可视化等功能。台州国富唐淼开发。">
    <meta name="keywords" content="不锈钢,牌号查询,GB标准,ASTM标准,EN标准,材料科学,工程材料,台州国富,唐淼">
    <meta name="author" content="唐淼 (台州国富)">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph -->
    <meta property="og:title" content="不锈钢牌号查询工作站">
    <meta property="og:description" content="专业的不锈钢牌号查询工作站，支持GB、ASTM、EN三大标准">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com">
    <meta property="og:image" content="https://your-domain.com/assets/images/og-image.png">
    
    <!-- 网站图标 -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 引入功能模块 -->
    <script src="data-enhancement.js"></script>
    <script src="advanced-search.js"></script>
    <script src="data-visualization.js"></script>
    <script src="search-enhancement.js"></script>
    <script src="mobile-optimization.js"></script>
    <script src="extended-data.js"></script>
    <script src="favorites.js"></script>
    <script src="performance-optimization.js"></script>
    <script src="analytics.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
            background-color: #0d1117; /* 更深的背景色 */
            color: #c9d1d9; 
        }
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }

        /* 自定义提示框 */
        #toast-pro {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: top 0.5s ease-in-out;
            z-index: 1001;
        }
        #toast-pro.show {
            top: 20px;
        }
        /* 列表项的进入动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .list-item-enter {
            animation: fadeIn 0.4s ease-out forwards;
        }
        /* 移动端和桌面端弹窗通用样式 */
        .modal-transition {
            transition: opacity 0.3s ease-in-out, visibility 0.3s;
        }
    </style>
</head>
<body class="text-gray-300">

    <!-- 主容器 -->
    <div class="flex flex-col h-screen">
        <!-- 头部 -->
        <header class="flex-shrink-0 bg-gray-900/70 backdrop-blur-md border-b border-gray-700 p-4 z-20">
            <div class="max-w-screen-2xl mx-auto">
                <div class="flex flex-col items-center space-y-2">
                    <h1 class="text-xl md:text-2xl font-bold text-white">不锈钢牌号查询工作站</h1>
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                        <span>台州国富</span>
                        <span>•</span>
                        <span>唐淼</span>
                        <span>•</span>
                        <span>2025 Beta 1.3</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主体内容区 -->
        <main class="flex-grow flex max-w-screen-2xl mx-auto w-full overflow-hidden relative">
            <!-- 左侧：搜索与操作区 -->
            <div class="w-full md:w-2/5 flex flex-col border-r border-gray-700">
                <!-- 搜索框区域 -->
                <div class="p-4 border-b border-gray-700 search-container">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="输入牌号、标准、UNS编号..." class="w-full bg-gray-800 border border-gray-600 rounded-lg py-3 px-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                
                <!-- 搜索结果区域 -->
                <div id="search-results-container" class="flex-grow overflow-y-auto p-2 space-y-3">
                    <!-- 搜索结果将在这里动态生成 -->
                </div>

                <!-- 页脚信息与反馈 -->
                <div class="flex-shrink-0 p-4 border-t border-gray-700 bg-gray-900/50">
                    <div class="text-sm text-gray-400 mb-3 space-y-1">
                        <p><strong>联系方式:</strong> 15861558321</p>
                        <p><strong>微信:</strong> <span id="wechat-id" class="cursor-pointer text-blue-400 hover:underline">wuxi3042205</span></p>
                        <p><strong>邮箱:</strong> <a href="mailto:wuxi304@outlook.com" class="text-blue-400 hover:underline">wuxi304@outlook.com</a></p>
                    </div>
                    <a href="mailto:wuxi304@outlook.com?subject=不锈钢牌号数据反馈&body=你好唐工，我发现以下数据可能存在问题：%0D%0A%0D%0A[请在此处填写您发现问题的牌号和具体内容，附上截图更佳]%0D%0A" 
                       class="w-full flex items-center justify-center gap-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                       问题反馈
                    </a>
                </div>
            </div>

            <!-- 右侧：对比工作台 -->
            <div class="hidden md:flex w-3/5 flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 class="text-lg font-semibold text-white">对比工作台</h2>
                    <div class="flex items-center gap-2">
                        <button id="export-comparison-btn" class="text-xs bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-full disabled:bg-gray-500 disabled:cursor-not-allowed">导出对比 (CSV)</button>
                        <button id="clear-comparison-btn" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-full disabled:bg-gray-500 disabled:cursor-not-allowed">一键清空</button>
                    </div>
                 </div>
                 <div class="p-4 flex-grow flex flex-col">
                    <div id="comparison-slots" class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4 min-h-[80px]">
                        <!-- 待对比的牌号卡片将在这里显示 -->
                    </div>
                    <div id="comparison-result" class="bg-gray-900/50 rounded-lg overflow-x-auto flex-grow">
                        <!-- 对比表格或提示信息 -->
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- 移动端对比浮动按钮 -->
    <button id="mobile-compare-fab" class="md:hidden fixed bottom-6 right-6 bg-blue-600 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg text-2xl z-30 hidden">
        ⚖️<span id="mobile-compare-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
    </button>

    <!-- 移动端对比弹窗 -->
    <div id="mobile-comparison-modal" class="md:hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-40 p-4 flex flex-col opacity-0 invisible modal-transition">
        <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
            <h2 class="text-lg font-semibold text-white">对比工作台</h2>
            <button id="mobile-modal-close" class="text-2xl text-gray-400">&times;</button>
        </div>
        <div id="mobile-comparison-content" class="flex-grow overflow-y-auto pt-4">
            <!-- 移动端对比内容将复制到这里 -->
        </div>
    </div>

    <!-- 微信二维码弹窗 -->
    <div id="wechat-qr-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 opacity-0 invisible modal-transition">
        <div id="wechat-qr-modal-content" class="bg-white p-4 rounded-lg relative">
            <button id="wechat-modal-close" class="absolute -top-3 -right-3 bg-gray-700 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg">&times;</button>
            <!-- 在下方src中替换为您自己的微信二维码图片地址 -->
            <img src="https://placehold.co/256x256/ffffff/000000?text=Your+QR+Code" alt="微信二维码" class="w-64 h-64">
        </div>
    </div>

    <!-- 自定义提示框 -->
    <div id="toast-pro" class="py-2 px-5 rounded-md text-sm font-semibold"></div>

<script>
// =================================================================================
// 模块：数据库和状态管理 (State & DB)
// =================================================================================
const DB = {
    gb: [
        {"name":"06Cr19Ni10","usn":"S30408","type":"奥氏体","碳":"≤0.08","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"18.0-20.0","镍":"8.0-11.0","钼":"—", "family": "304", "spec": "GB/T 20878 / 713.7", "yield_strength": "≥205", "tensile_strength": "≥520"},
        {"name":"022Cr19Ni10","usn":"S30403","type":"奥氏体","碳":"≤0.030","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"18.0-20.0","镍":"8.0-12.0","钼":"—", "family": "304L", "spec": "GB/T 20878 / 713.7", "yield_strength": "≥175", "tensile_strength": "≥480"},
        {"name":"06Cr17Ni12Mo2","usn":"S31608","type":"奥氏体","碳":"≤0.08","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"16.0-18.0","镍":"10.0-14.0","钼":"2.0-3.0", "family": "316", "spec": "GB/T 20878 / 713.7", "yield_strength": "≥205", "tensile_strength": "≥520"},
        {"name":"022Cr17Ni12Mo2","usn":"S31603","type":"奥氏体","碳":"≤0.030","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"16.0-18.0","镍":"10.0-14.0","钼":"2.0-3.0", "family": "316L", "spec": "GB/T 20878 / 713.7", "yield_strength": "≥175", "tensile_strength": "≥480"},
        {"name":"10Cr17","usn":"S11710","type":"铁素体","碳":"≤0.12","硅":"≤1.00","锰":"≤1.00","磷":"≤0.040","硫":"≤0.030","铬":"16.0-18.0","镍":"—","钼":"—", "family": "430", "spec": "GB/T 20878 / 713.7", "yield_strength": "≥205", "tensile_strength": "≥450"},
    ],
    astm: [
        {"name":"304","usn":"S30400","type":"奥氏体","碳":"≤0.08","硅":"≤0.75","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"18.0-20.0","镍":"8.0-11.0","钼":"—", "family": "304", "spec": "ASTM A240/A240M", "yield_strength": "≥205", "tensile_strength": "≥515"},
        {"name":"304L","usn":"S30403","type":"奥氏体","碳":"≤0.030","硅":"≤0.75","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"18.0-20.0","镍":"8.0-12.0","钼":"—", "family": "304L", "spec": "ASTM A240/A240M", "yield_strength": "≥170", "tensile_strength": "≥485"},
        {"name":"316","usn":"S31600","type":"奥氏体","碳":"≤0.08","硅":"≤0.75","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"16.0-18.0","镍":"10.0-14.0","钼":"2.0-3.0", "family": "316", "spec": "ASTM A240/A240M", "yield_strength": "≥205", "tensile_strength": "≥515"},
        {"name":"316L","usn":"S31603","type":"奥氏体","碳":"≤0.030","硅":"≤0.75","锰":"≤2.00","磷":"≤0.045","硫":"≤0.030","铬":"16.0-18.0","镍":"10.0-14.0","钼":"2.0-3.0", "family": "316L", "spec": "ASTM A240/A240M", "yield_strength": "≥170", "tensile_strength": "≥485"},
        {"name":"2205","usn":"S32205","type":"双相钢","碳":"≤0.030","硅":"≤1.00","锰":"≤2.00","磷":"≤0.030","硫":"≤0.020","铬":"22.0-23.0","镍":"4.5-6.5","钼":"3.0-3.5", "family": "2205", "spec": "ASTM A240/A240M", "yield_strength": "≥450", "tensile_strength": "≥655"},
        {"name":"430","usn":"S43000","type":"铁素体","碳":"≤0.12","硅":"≤1.00","锰":"≤1.00","磷":"≤0.040","硫":"≤0.030","铬":"16.0-18.0","镍":"≤0.75","钼":"—", "family": "430", "spec": "ASTM A240/A240M", "yield_strength": "≥205", "tensile_strength": "≥450"},
    ],
    en: [
        {"name":"1.4301","usn":"X5CrNi18-10","type":"奥氏体","碳":"≤0.07","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.015","铬":"17.5-19.5","镍":"8.0-10.5","钼":"—", "family": "304", "spec": "EN 10028-7 / 10088-2", "yield_strength": "≥210", "tensile_strength": "520-720"},
        {"name":"1.4307","usn":"X2CrNi18-9","type":"奥氏体","碳":"≤0.03","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.015","铬":"17.5-19.5","镍":"8.0-10.5","钼":"—", "family": "304L", "spec": "EN 10028-7 / 10088-2", "yield_strength": "≥200", "tensile_strength": "500-700"},
        {"name":"1.4401","usn":"X5CrNiMo17-12-2","type":"奥氏体","碳":"≤0.07","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.015","铬":"16.5-18.5","镍":"10.0-13.0","钼":"2.00-2.50", "family": "316", "spec": "EN 10028-7 / 10088-2", "yield_strength": "≥220", "tensile_strength": "520-670"},
        {"name":"1.4404","usn":"X2CrNiMo17-12-2","type":"奥氏体","碳":"≤0.03","硅":"≤1.00","锰":"≤2.00","磷":"≤0.045","硫":"≤0.015","铬":"16.5-18.5","镍":"10.0-13.0","钼":"2.00-2.50", "family": "316L", "spec": "EN 10028-7 / 10088-2", "yield_strength": "≥220", "tensile_strength": "520-670"},
        {"name":"1.4462","usn":"X2CrNiMoN22-5-3","type":"双相钢","碳":"≤0.030","硅":"≤1.00","锰":"≤2.00","磷":"≤0.035","硫":"≤0.015","铬":"21.0-23.0","镍":"4.5-6.5","钼":"2.50-3.5", "family": "2205", "spec": "EN 10028-7 / 10088-2", "yield_strength": "≥460", "tensile_strength": "640-840"},
    ]
};

const AppState = {
    allData: [],
    searchResultGroups: {},
    comparisonList: [], 
};

// =================================================================================
// 模块：工具函数 (Utils)
// =================================================================================
const Utils = {
    debounce(func, delay) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        };
    },
    showToast(message, type = 'success') {
        const toast = document.getElementById('toast-pro');
        toast.textContent = message;
        toast.className = 'py-2 px-5 rounded-md text-sm font-semibold show ';
        if (type === 'error') {
            toast.classList.add('bg-red-600', 'text-white');
        } else {
            toast.classList.add('bg-blue-600', 'text-white');
        }
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    },
    downloadCSV(content, fileName) {
        const blob = new Blob([`\uFEFF${content}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};

// =================================================================================
// 模块：UI渲染 (UI)
// =================================================================================
const UI = {
    getStandardBadge(standard) {
        const colors = {
            'GB': 'bg-red-500 text-white',
            'ASTM': 'bg-blue-500 text-white',
            'EN': 'bg-green-500 text-white',
        };
        return `<span class="flex-shrink-0 text-xs font-semibold px-2 py-1 rounded-full ${colors[standard] || 'bg-gray-500'}">${standard}</span>`;
    },
    renderSearchResults() {
        const container = document.getElementById('search-results-container');
        const groups = AppState.searchResultGroups;
        const groupKeys = Object.keys(groups);

        if (groupKeys.length === 0) {
            container.innerHTML = `<div class="text-center p-10 text-gray-500">无搜索结果</div>`;
            return;
        }
        
        container.innerHTML = groupKeys.map((family, index) => {
            const items = groups[family];
            const itemsHtml = items.map(steel => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-700/50 rounded-md">
                    <div class="flex items-center gap-2 overflow-hidden">
                        ${this.getStandardBadge(steel.standard)}
                        <div class="flex flex-col overflow-hidden">
                           <span class="font-medium text-gray-300 truncate">${steel.name}</span>
                           <span class="text-xs text-gray-500 truncate" title="${steel.spec}">${steel.spec}</span>
                        </div>
                    </div>
                    <button title="单独添加到对比" class="add-to-compare-btn text-xl text-blue-400 hover:text-blue-300 flex-shrink-0" data-id="${steel.id}">⊕</button>
                </div>
            `).join('');

            return `
                <div class="bg-gray-800 rounded-lg p-3 list-item-enter" style="animation-delay: ${index * 30}ms;">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-white">${family} 等效牌号组</h3>
                        <button class="add-group-to-compare-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded-full" data-family="${family}">一键对比</button>
                    </div>
                    <div class="space-y-1">${itemsHtml}</div>
                </div>
            `;
        }).join('');
    },
    renderComparisonArea() {
        const slotsContainer = document.getElementById('comparison-slots');
        const resultContainer = document.getElementById('comparison-result');
        const clearBtn = document.getElementById('clear-comparison-btn');
        const exportBtn = document.getElementById('export-comparison-btn');
        const mobileFab = document.getElementById('mobile-compare-fab');
        const mobileCount = document.getElementById('mobile-compare-count');
        
        const hasItems = AppState.comparisonList.length > 0;
        clearBtn.disabled = !hasItems;
        exportBtn.disabled = AppState.comparisonList.length < 2;
        
        if (hasItems) {
            mobileFab.classList.remove('hidden');
            mobileCount.textContent = AppState.comparisonList.length;
        } else {
            mobileFab.classList.add('hidden');
        }

        if (AppState.comparisonList.length === 0) {
            slotsContainer.innerHTML = `<div class="col-span-1 lg:col-span-3 text-center p-6 text-gray-500">从左侧搜索结果中点击 '⊕' 或 '一键对比' 添加牌号</div>`;
        } else {
            slotsContainer.innerHTML = AppState.comparisonList.map(steel => `
                <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center list-item-enter">
                    <div>
                        ${this.getStandardBadge(steel.standard)}
                        <span class="font-bold text-white ml-2">${steel.name}</span>
                    </div>
                    <button title="移出对比" class="remove-from-compare-btn text-red-400 hover:text-red-300 text-xl" data-id="${steel.id}">⊖</button>
                </div>
            `).join('');
        }

        if (AppState.comparisonList.length < 2) {
            resultContainer.innerHTML = `<div class="text-center p-10 text-gray-500">请至少添加两个牌号以生成对比表格</div>`;
            return;
        }

        const headers = ['属性', ...AppState.comparisonList.map(item => `${item.name} (${item.standard})`)];
        const keys = [
            { key: 'spec', label: '执行标准' },
            { key: 'type', label: '类型' },
            { key: 'usn', label: 'UNS/Name' },
            { key: 'yield_strength', label: '屈服强度 (MPa)' },
            { key: 'tensile_strength', label: '抗拉强度 (MPa)' },
            { key: '碳', label: '碳 (C)' }, { key: '硅', label: '硅 (Si)' },
            { key: '锰', label: '锰 (Mn)' }, { key: '磷', label: '磷 (P)' },
            { key: '硫', label: '硫 (S)' }, { key: '铬', label: '铬 (Cr)' },
            { key: '镍', label: '镍 (Ni)' }, { key: '钼', label: '钼 (Mo)' },
        ];
        
        const colorClasses = ['bg-sky-900/50', 'bg-emerald-900/50', 'bg-amber-900/50', 'bg-rose-900/50'];
        let tableHtml = `<table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-gray-800"><tr>${headers.map(h => `<th class="px-6 py-3">${h}</th>`).join('')}</tr></thead><tbody>`;
        
        keys.forEach(({key, label}) => {
            const values = AppState.comparisonList.map(item => item[key] || '—');
            if (values.every(v => v === '—')) return; 
            
            const uniqueValues = [...new Set(values)];
            let rowHtml = '';
            if (uniqueValues.length > 1) {
                const valueMap = new Map();
                let groupIndex = 0;
                uniqueValues.forEach(v => {
                    valueMap.set(v, groupIndex++);
                });
                const cells = values.map(v => {
                    const group = valueMap.get(v);
                    return `<td class="px-6 py-4 ${colorClasses[group % colorClasses.length]}">${v}</td>`;
                }).join('');
                rowHtml = `<tr class="border-b border-gray-700"><td class="px-6 py-4 font-medium text-white">${label}</td>${cells}</tr>`;
            } else {
                rowHtml = `<tr class="border-b border-gray-700"><td class="px-6 py-4 font-medium text-white">${label}</td>${values.map(v => `<td class="px-6 py-4">${v}</td>`).join('')}</tr>`;
            }
            tableHtml += rowHtml;
        });

        tableHtml += '</tbody></table>';
        resultContainer.innerHTML = tableHtml;
    }
};

// =================================================================================
// 模块：核心逻辑 (Core)
// =================================================================================
const Core = {
    init() {
        this.prepareData();
        this.globalSearch(''); // Initial search to show all groups
        UI.renderComparisonArea();
        this.addEventListeners();
    },
    prepareData() {
        let idCounter = 0;
        const processDB = (db, standardName) => db.map(item => {
            const newItem = {...item};
            newItem.standard = standardName;
            newItem.id = idCounter++;
            if (newItem.type.includes('Austenitic')) newItem.type = '奥氏体';
            if (newItem.type.includes('Ferritic')) newItem.type = '铁素体';
            if (newItem.type.includes('Martensitic')) newItem.type = '马氏体';
            if (newItem.type.includes('Duplex')) newItem.type = '双相钢';
            for (const key in newItem) {
                if (typeof newItem[key] === 'string') {
                    newItem[key] = newItem[key].replace(/~/g, '-');
                }
            }
            return newItem;
        });
        AppState.allData = [
            ...processDB(DB.gb, 'GB'),
            ...processDB(DB.astm, 'ASTM'),
            ...processDB(DB.en, 'EN')
        ];
    },
    globalSearch(query) {
        query = query.toLowerCase().trim();
        const results = query 
            ? AppState.allData.filter(item => 
                item.name.toLowerCase().includes(query) || 
                (item.usn && item.usn.toLowerCase().includes(query)) ||
                item.family.toLowerCase().includes(query)
              )
            : [...AppState.allData];

        AppState.searchResultGroups = results.reduce((acc, item) => {
            const family = item.family || item.name;
            if (!acc[family]) acc[family] = [];
            acc[family].push(item);
            return acc;
        }, {});

        UI.renderSearchResults();
    },
    addToComparison(itemId) {
        if (AppState.comparisonList.length >= 3) {
            Utils.showToast('最多只能对比三个牌号', 'error');
            return false;
        }
        if (AppState.comparisonList.some(item => item.id === itemId)) {
            Utils.showToast('该牌号已在对比列表中', 'error');
            return false;
        }
        const itemToAdd = AppState.allData.find(s => s.id === itemId);
        if (itemToAdd) {
            AppState.comparisonList.push(itemToAdd);
            return true;
        }
        return false;
    },
    removeFromComparison(itemId) {
        AppState.comparisonList = AppState.comparisonList.filter(item => item.id !== itemId);
        UI.renderComparisonArea();
    },
    exportComparison() {
        if (AppState.comparisonList.length < 1) {
            Utils.showToast('对比台为空，无法导出', 'error');
            return;
        }
        const headers = ['属性', ...AppState.comparisonList.map(item => `${item.name} (${item.standard})`)];
        const keys = [
            { key: 'spec', label: '执行标准' }, { key: 'type', label: '类型' }, { key: 'usn', label: 'UNS/Name' },
            { key: 'yield_strength', label: '屈服强度 (MPa)' }, { key: 'tensile_strength', label: '抗拉强度 (MPa)' },
            { key: '碳', label: '碳 (C)' }, { key: '硅', label: '硅 (Si)' }, { key: '锰', label: '锰 (Mn)' },
            { key: '磷', label: '磷 (P)' }, { key: '硫', label: '硫 (S)' }, { key: '铬', label: '铬 (Cr)' },
            { key: '镍', label: '镍 (Ni)' }, { key: '钼', label: '钼 (Mo)' },
        ];
        
        let csvContent = headers.join(',') + '\n';
        keys.forEach(({key, label}) => {
            const values = AppState.comparisonList.map(item => item[key] || '—');
            if (!values.every(v => v === '—')) {
                 csvContent += `"${label}",${values.map(v => `"${v}"`).join(',')}\n`;
            }
        });

        Utils.downloadCSV(csvContent, 'stainless-steel-comparison.csv');
    },
    addEventListeners() {
        const searchInput = document.getElementById('globalSearchInput');
        searchInput.addEventListener('input', Utils.debounce(() => this.globalSearch(searchInput.value), 250));
        
        document.getElementById('search-results-container').addEventListener('click', (e) => {
            const addButton = e.target.closest('.add-to-compare-btn');
            if (addButton) {
                if (this.addToComparison(parseInt(addButton.dataset.id))) UI.renderComparisonArea();
            }
            const addGroupButton = e.target.closest('.add-group-to-compare-btn');
            if (addGroupButton) {
                const family = addGroupButton.dataset.family;
                const itemsToAdd = AppState.searchResultGroups[family];
                let addedCount = 0;
                itemsToAdd.forEach(item => { if (this.addToComparison(item.id)) addedCount++; });
                if (addedCount > 0) {
                    UI.renderComparisonArea();
                    Utils.showToast(`已添加 ${addedCount} 个牌号到对比台`);
                }
            }
        });
        
        document.getElementById('comparison-slots').addEventListener('click', (e) => {
            const removeButton = e.target.closest('.remove-from-compare-btn');
            if (removeButton) this.removeFromComparison(parseInt(removeButton.dataset.id));
        });

        document.getElementById('clear-comparison-btn').addEventListener('click', () => {
            AppState.comparisonList = [];
            UI.renderComparisonArea();
        });

        document.getElementById('export-comparison-btn').addEventListener('click', () => this.exportComparison());

        // Mobile modal logic
        const modal = document.getElementById('mobile-comparison-modal');
        const mobileContent = document.getElementById('mobile-comparison-content');
        const desktopSlots = document.getElementById('comparison-slots');
        const desktopResult = document.getElementById('comparison-result');
        
        document.getElementById('mobile-compare-fab').addEventListener('click', () => {
            mobileContent.innerHTML = `<div class="p-4">${desktopSlots.innerHTML}</div><div class="p-4">${desktopResult.innerHTML}</div>`;
            modal.classList.remove('opacity-0', 'invisible');
        });
        document.getElementById('mobile-modal-close').addEventListener('click', () => {
            modal.classList.add('opacity-0', 'invisible');
        });

        // WeChat QR Modal Logic
        const wechatModal = document.getElementById('wechat-qr-modal');
        document.getElementById('wechat-id').addEventListener('click', () => {
            wechatModal.classList.remove('opacity-0', 'invisible');
        });
        document.getElementById('wechat-modal-close').addEventListener('click', () => {
            wechatModal.classList.add('opacity-0', 'invisible');
        });
        wechatModal.addEventListener('click', (e) => {
            if(e.target === wechatModal) {
                 wechatModal.classList.add('opacity-0', 'invisible');
            }
        });
    }
};

// =================================================================================
// 模块：初始化
// =================================================================================
document.addEventListener('DOMContentLoaded', () => Core.init());

</script>
</body>
</html>
